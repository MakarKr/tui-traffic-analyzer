name: Auto Release on Every Commit

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

# Даем разрешение на запись в репозиторий
permissions:
  contents: write

jobs:
  build:
    name: Build Release Assets
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        python-version: [3.12]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-dev python3-pip python3-setuptools patchelf desktop-file-utils libgdk-pixbuf2.0-dev fakeroot strace rpm libfuse2
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Install dependencies (Windows)
      if: runner.os == 'Windows'
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Build Windows Executable
      if: runner.os == 'Windows'
      run: |
        pyinstaller --onefile --console --name "tui-traffic-analyzer" --add-data "config.py;." --add-data "DISCLAIMER.md;." main.py
        mv dist/tui-traffic-analyzer.exe tui-traffic-analyzer-windows-x64.exe

    - name: Build Linux AppImage
      if: runner.os == 'Linux'
      run: |
        sudo apt-get install -y libfuse2
        wget -O appimagetool "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage"
        chmod +x appimagetool

        mkdir -p AppDir/usr/bin
        mkdir -p AppDir/usr/share/applications

        pyinstaller --onefile main.py

        cp dist/main AppDir/usr/bin/tui-traffic-analyzer

        echo "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==" | base64 -d > AppDir/usr/bin/tui-traffic-analyzer.png

        cat > AppDir/usr/share/applications/tui-traffic-analyzer.desktop << EOF
        [Desktop Entry]
        Name=TUI Traffic Analyzer
        Exec=tui-traffic-analyzer
        Icon=tui-traffic-analyzer
        Type=Application
        Terminal=true
        Categories=Network;System;
        EOF

        cat > AppDir/AppRun << 'EOF'
        #!/bin/bash
        HERE="$(dirname "$(readlink -f "${0}")")"
        export LD_LIBRARY_PATH="${HERE}/usr/lib/:${LD_LIBRARY_PATH}"
        exec "${HERE}/usr/bin/tui-traffic-analyzer" "$@"
        EOF

        chmod +x AppDir/AppRun
        chmod +x AppDir/usr/bin/tui-traffic-analyzer

        ln -s usr/share/applications/tui-traffic-analyzer.desktop AppDir/tui-traffic-analyzer.desktop
        ln -s usr/bin/tui-traffic-analyzer.png AppDir/tui-traffic-analyzer.png

        ./appimagetool --no-appstream AppDir
        mv TUI_Traffic_Analyzer-x86_64.AppImage tui-traffic-analyzer-linux-x86_64.AppImage

    - name: Build DEB Package
      if: runner.os == 'Linux'
      run: |
        pyinstaller --onefile main.py

        mkdir -p tui-traffic-analyzer/usr/bin
        mkdir -p tui-traffic-analyzer/usr/share/doc/tui-traffic-analyzer
        mkdir -p tui-traffic-analyzer/DEBIAN

        cp dist/main tui-traffic-analyzer/usr/bin/tui-traffic-analyzer
        cp README.md tui-traffic-analyzer/usr/share/doc/tui-traffic-analyzer/ || true
        cp LICENSE tui-traffic-analyzer/usr/share/doc/tui-traffic-analyzer/ || true

        chmod +x tui-traffic-analyzer/usr/bin/tui-traffic-analyzer

        cat > tui-traffic-analyzer/DEBIAN/control << EOF
        Package: tui-traffic-analyzer
        Version: 1.0.0
        Section: net
        Priority: optional
        Architecture: amd64
        Depends: python3
        Maintainer: Makar Krapivin <mackarkrapivin505@gmail.com>
        Description: TUI Traffic Analyzer
         Network traffic analysis tool with TUI interface
        EOF

        dpkg-deb --build tui-traffic-analyzer
        mv tui-traffic-analyzer.deb tui-traffic-analyzer-linux-amd64.deb

    - name: Build RPM Package
      if: runner.os == 'Linux'
      run: |
        pyinstaller --onefile main.py

        if [ ! -f dist/main ]; then
          echo "Error: dist/main not found"
          ls -la dist/
          exit 1
        fi

        mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS,BUILDROOT}

        cp dist/main ~/rpmbuild/SOURCES/tui-traffic-analyzer

        cat > ~/rpmbuild/SPECS/tui-traffic-analyzer.spec << EOF
        Name: tui-traffic-analyzer
        Version: 1.0.0
        Release: 1
        Summary: TUI Traffic Analyzer
        License: GPL-3.0
        BuildArch: x86_64

        %description
        Network traffic analysis tool with TUI interface

        %files
        /usr/bin/tui-traffic-analyzer

        %prep

        %build

        %install
        mkdir -p %{buildroot}/usr/bin
        cp %{_sourcedir}/tui-traffic-analyzer %{buildroot}/usr/bin/tui-traffic-analyzer
        chmod +x %{buildroot}/usr/bin/tui-traffic-analyzer

        %changelog
        * $(date +"%a %b %d %Y") Makar Krapivin <mackarkrapivin505@gmail.com> - 1.0.0-1
        - Initial build
        EOF

        rpmbuild -bb ~/rpmbuild/SPECS/tui-traffic-analyzer.spec
        cp ~/rpmbuild/RPMS/x86_64/tui-traffic-analyzer-1.0.0-1.x86_64.rpm tui-traffic-analyzer-linux-x86_64.rpm

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts-${{ runner.os }}
        path: |
          tui-traffic-analyzer-windows-x64.exe
          tui-traffic-analyzer-linux-x86_64.AppImage
          tui-traffic-analyzer-linux-amd64.deb
          tui-traffic-analyzer-linux-x86_64.rpm

  create-release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    permissions:
      contents: write
      packages: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        merge-multiple: true

    - name: Get current date and time
      id: datetime
      run: echo "datetime=$(date +'%d.%m.%Y %H:%M')" >> $GITHUB_OUTPUT

    - name: Get commit hash from context
      id: commit
      run: echo "hash=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

    - name: Prepare release files
      run: |
        mkdir -p release-files

        find artifacts -type f -name "*.exe" -exec cp {} release-files/ \; 2>/dev/null || true
        find artifacts -type f -name "*.AppImage" -exec cp {} release-files/ \; 2>/dev/null || true
        find artifacts -type f -name "*.deb" -exec cp {} release-files/ \; 2>/dev/null || true
        find artifacts -type f -name "*.rpm" -exec cp {} release-files/ \; 2>/dev/null || true

        ls -la release-files/

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: build-${{ steps.datetime.outputs.datetime }}-${{ steps.commit.outputs.hash }}
        name: "Build ${{ steps.datetime.outputs.datetime }} (${{ steps.commit.outputs.hash }})"
        body: |
          **Built on:** ${{ steps.datetime.outputs.datetime }}
          **Commit:** ${{ steps.commit.outputs.hash }}

          ### Included Files:
          - Windows Executable (.exe)
          - Linux AppImage (.AppImage)
          - Debian Package (.deb)
          - RPM Package (.rpm)

          ### Build Information:
          - Python 3.12
          - Built automatically on every commit
        draft: false
        prerelease: false
        files: |
          release-files/tui-traffic-analyzer-windows-x64.exe
          release-files/tui-traffic-analyzer-linux-x86_64.AppImage
          release-files/tui-traffic-analyzer-linux-amd64.deb
          release-files/tui-traffic-analyzer-linux-x86_64.rpm

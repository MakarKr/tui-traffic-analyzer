name: Auto Release on Every Commit

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    name: Build Release Assets
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-20.04, windows-latest]
        python-version: [3.9]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-dev python3-pip python3-setuptools patchelf desktop-file-utils libgdk-pixbuf2.0-dev fakeroot strace
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Install dependencies (Windows)
      if: runner.os == 'Windows'
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Build Windows Executable
      if: runner.os == 'Windows'
      run: |
        pyinstaller --onefile --windowed --name "tui-traffic-analyzer" --add-data "config.py;." --add-data "DISCLAIMER.md;." main.py
        echo "Windows build completed"

    - name: Build Linux AppImage
      if: runner.os == 'Linux'
      run: |
        # Install AppImage tools
        wget -O appimagetool "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage"
        chmod +x appimagetool

        # Create AppDir structure
        mkdir -p AppDir/usr/bin
        mkdir -p AppDir/usr/lib
        mkdir -p AppDir/usr/share/applications
        mkdir -p AppDir/usr/share/icons

        # Build with PyInstaller
        pyinstaller --onefile main.py

        # Copy executable
        cp dist/main AppDir/usr/bin/tui-traffic-analyzer

        # Create desktop file
        cat > AppDir/usr/share/applications/tui-traffic-analyzer.desktop << EOF
        [Desktop Entry]
        Name=TUI Traffic Analyzer
        Exec=tui-traffic-analyzer
        Type=Application
        Terminal=true
        Icon=tui-traffic-analyzer
        Categories=Network;Security;
        EOF

        # Create AppRun script
        cat > AppDir/AppRun << EOF
        #!/bin/bash
        HERE="\$(dirname "\$(readlink -f "\${0}")")"
        export LD_LIBRARY_PATH="\${HERE}/usr/lib/:\${LD_LIBRARY_PATH}"
        exec "\${HERE}/usr/bin/tui-traffic-analyzer" "\$@"
        EOF

        chmod +x AppDir/AppRun

        # Create symbolic link for icon
        ln -s usr/share/applications/tui-traffic-analyzer.desktop AppDir/tui-traffic-analyzer.desktop

        # Create AppImage
        ./appimagetool AppDir
        mv TUI_Traffic_Analyzer-x86_64.AppImage tui-traffic-analyzer-linux-x86_64.AppImage

    - name: Build DEB Package
      if: runner.os == 'Linux'
      run: |
        # Create DEB structure
        mkdir -p tui-traffic-analyzer/usr/bin
        mkdir -p tui-traffic-analyzer/usr/share/doc/tui-traffic-analyzer
        mkdir -p tui-traffic-analyzer/DEBIAN

        # Copy files
        cp dist/main tui-traffic-analyzer/usr/bin/tui-traffic-analyzer
        cp README.md tui-traffic-analyzer/usr/share/doc/tui-traffic-analyzer/
        cp LICENSE tui-traffic-analyzer/usr/share/doc/tui-traffic-analyzer/

        # Make executable
        chmod +x tui-traffic-analyzer/usr/bin/tui-traffic-analyzer

        # Create control file
        cat > tui-traffic-analyzer/DEBIAN/control << EOF
        Package: tui-traffic-analyzer
        Version: 1.0.0
        Section: net
        Priority: optional
        Architecture: amd64
        Depends: python3
        Maintainer: Makar Krapivin <mackarkrapivin505@gmail.com>
        Description: TUI Traffic Analyzer
         Network traffic analysis tool with TUI interface
        Built: $(date +%d.%m.%Y)
        EOF

        # Build DEB
        dpkg-deb --build tui-traffic-analyzer
        mv tui-traffic-analyzer.deb tui-traffic-analyzer-linux-amd64.deb

    - name: Build RPM Package
      if: runner.os == 'Linux'
      run: |
        # Install RPM tools
        sudo apt-get install -y rpm

        # Create RPM build structure
        mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}

        # Create tarball
        tar -czf ~/rpmbuild/SOURCES/tui-traffic-analyzer.tar.gz --exclude='.git' .

        # Create spec file
        cat > ~/rpmbuild/SPECS/tui-traffic-analyzer.spec << EOF
        Name: tui-traffic-analyzer
        Version: 1.0.0
        Release: 1
        Summary: TUI Traffic Analyzer
        License: GPL-3.0
        BuildArch: x86_64

        Requires: python3

        %description
        Network traffic analysis tool with TUI interface

        %prep
        %setup -q

        %build
        python3 -m pip install --root=%{buildroot} -r requirements.txt

        %install
        mkdir -p %{buildroot}/usr/bin
        cp main.py %{buildroot}/usr/bin/tui-traffic-analyzer
        chmod +x %{buildroot}/usr/bin/tui-traffic-analyzer

        %files
        /usr/bin/tui-traffic-analyzer

        %changelog
        * $(date +"%a %b %d %Y") Makar Krapivin <mackarkrapivin505@gmail.com> - 1.0.0-1
        - Initial build $(date +%d.%m.%Y)
        EOF

        # Build RPM
        rpmbuild -bb ~/rpmbuild/SPECS/tui-traffic-analyzer.spec
        cp ~/rpmbuild/RPMS/x86_64/tui-traffic-analyzer-1.0.0-1.x86_64.rpm tui-traffic-analyzer-linux-x86_64.rpm

    - name: Upload Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: build-artifacts-${{ runner.os }}
        path: |
          *.exe
          *.AppImage
          *.deb
          *.rpm

  create-release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-20.04
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v3
      with:
        path: artifacts

    - name: Get current date
      id: date
      run: echo "date=$(date +%d.%m.%Y)" >> $GITHUB_OUTPUT

    - name: Get commit hash
      id: commit
      run: echo "hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

    - name: Create Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: build-${{ steps.date.outputs.date }}-${{ steps.commit.outputs.hash }}
        release_name: "Build ${{ steps.date.outputs.date }} (${{ steps.commit.outputs.hash }})"
        body: |
          ## Automatic Build Release

          Built on: ${{ steps.date.outputs.date }}
          Commit: ${{ steps.commit.outputs.hash }}

          ### Included Files:
          - Windows Executable (.exe)
          - Linux AppImage (.AppImage)
          - Debian Package (.deb)
          - RPM Package (.rpm)

          ### Build Information:
          - Python 3.9
          - Built automatically on every commit

          **Note:** This is an automatic build. For production use, please check the latest stable release.
        draft: false
        prerelease: true

    - name: Upload Release Assets
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./artifacts/build-artifacts-Windows/*.exe
        asset_name: tui-traffic-analyzer-windows-x64.exe
        asset_content_type: application/octet-stream

    - name: Upload AppImage
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./artifacts/build-artifacts-Linux/tui-traffic-analyzer-linux-x86_64.AppImage
        asset_name: tui-traffic-analyzer-linux-x86_64.AppImage
        asset_content_type: application/octet-stream

    - name: Upload DEB
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./artifacts/build-artifacts-Linux/tui-traffic-analyzer-linux-amd64.deb
        asset_name: tui-traffic-analyzer-linux-amd64.deb
        asset_content_type: application/vnd.debian.binary-package

    - name: Upload RPM
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./artifacts/build-artifacts-Linux/tui-traffic-analyzer-linux-x86_64.rpm
        asset_name: tui-traffic-analyzer-linux-x86_64.rpm
        asset_content_type: application/x-rpm

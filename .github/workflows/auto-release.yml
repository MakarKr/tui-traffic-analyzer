name: Auto Release on Every Commit

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    name: Build Release Assets
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        python-version: [3.12]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-dev python3-pip python3-setuptools patchelf desktop-file-utils libgdk-pixbuf2.0-dev fakeroot strace rpm libfuse2
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Install dependencies (Windows)
      if: runner.os == 'Windows'
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Build Windows Executable
      if: runner.os == 'Windows'
      run: |
        pyinstaller --onefile --console --name "tui-traffic-analyzer" --add-data "config.py;." --add-data "DISCLAIMER.md;." main.py
        echo "Windows build completed"

    - name: Build Linux AppImage
      if: runner.os == 'Linux'
      run: |
        # Install AppImage tools with FUSE support
        sudo apt-get install -y libfuse2
        wget -O appimagetool "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage"
        chmod +x appimagetool

        # Create AppDir structure
        mkdir -p AppDir/usr/bin
        mkdir -p AppDir/usr/share/applications

        # Build with PyInstaller
        pyinstaller --onefile main.py

        # Copy executable
        cp dist/main AppDir/usr/bin/tui-traffic-analyzer

        # Create a transparent 1x1 pixel PNG icon
        echo "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==" | base64 -d > AppDir/usr/bin/tui-traffic-analyzer.png

        # Create desktop file with icon
        cat > AppDir/usr/share/applications/tui-traffic-analyzer.desktop << EOF
        [Desktop Entry]
        Name=TUI Traffic Analyzer
        Exec=tui-traffic-analyzer
        Icon=tui-traffic-analyzer
        Type=Application
        Terminal=true
        Categories=Network;System;
        EOF

        # Create AppRun script
        cat > AppDir/AppRun << 'EOF'
        #!/bin/bash
        HERE="$(dirname "$(readlink -f "${0}")")"
        export LD_LIBRARY_PATH="${HERE}/usr/lib/:${LD_LIBRARY_PATH}"
        exec "${HERE}/usr/bin/tui-traffic-analyzer" "$@"
        EOF

        chmod +x AppDir/AppRun
        chmod +x AppDir/usr/bin/tui-traffic-analyzer

        # Create symbolic links for desktop file and icon
        ln -s usr/share/applications/tui-traffic-analyzer.desktop AppDir/tui-traffic-analyzer.desktop
        ln -s usr/bin/tui-traffic-analyzer.png AppDir/tui-traffic-analyzer.png

        # Create AppImage with --no-appstream to avoid AppStream issues
        ./appimagetool --no-appstream AppDir
        mv TUI_Traffic_Analyzer-x86_64.AppImage tui-traffic-analyzer-linux-x86_64.AppImage

    - name: Build DEB Package
      if: runner.os == 'Linux'
      run: |
        # Create DEB structure
        mkdir -p tui-traffic-analyzer/usr/bin
        mkdir -p tui-traffic-analyzer/usr/share/doc/tui-traffic-analyzer
        mkdir -p tui-traffic-analyzer/DEBIAN

        # Copy files
        cp dist/main tui-traffic-analyzer/usr/bin/tui-traffic-analyzer
        cp README.md tui-traffic-analyzer/usr/share/doc/tui-traffic-analyzer/ || touch tui-traffic-analyzer/usr/share/doc/tui-traffic-analyzer/README
        cp LICENSE tui-traffic-analyzer/usr/share/doc/tui-traffic-analyzer/ || touch tui-traffic-analyzer/usr/share/doc/tui-traffic-analyzer/LICENSE

        # Make executable
        chmod +x tui-traffic-analyzer/usr/bin/tui-traffic-analyzer

        # Create control file
        cat > tui-traffic-analyzer/DEBIAN/control << EOF
        Package: tui-traffic-analyzer
        Version: 1.0.0
        Section: net
        Priority: optional
        Architecture: amd64
        Depends: python3
        Maintainer: Makar Krapivin <mackarkrapivin505@gmail.com>
        Description: TUI Traffic Analyzer
         Network traffic analysis tool with TUI interface
        Built: $(date +%d.%m.%Y)
        EOF

        # Build DEB
        dpkg-deb --build tui-traffic-analyzer
        mv tui-traffic-analyzer.deb tui-traffic-analyzer-linux-amd64.deb

    - name: Build RPM Package
      if: runner.os == 'Linux'
      run: |
        # Create basic RPM structure
        mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS,BUILDROOT}

        # Create simple spec file
        cat > ~/rpmbuild/SPECS/tui-traffic-analyzer.spec << EOF
        Name: tui-traffic-analyzer
        Version: 1.0.0
        Release: 1
        Summary: TUI Traffic Analyzer
        License: GPL-3.0
        BuildArch: x86_64

        %description
        Network traffic analysis tool with TUI interface

        %files
        /usr/bin/tui-traffic-analyzer

        %prep

        %build

        %install
        mkdir -p %{buildroot}/usr/bin
        cp dist/main %{buildroot}/usr/bin/tui-traffic-analyzer
        chmod +x %{buildroot}/usr/bin/tui-traffic-analyzer

        %changelog
        * $(date +"%a %b %d %Y") Makar Krapivin <mackarkrapivin505@gmail.com> - 1.0.0-1
        - Initial build $(date +%d.%m.%Y)
        EOF

        # Build RPM
        rpmbuild -bb ~/rpmbuild/SPECS/tui-traffic-analyzer.spec
        cp ~/rpmbuild/RPMS/x86_64/tui-traffic-analyzer-1.0.0-1.x86_64.rpm tui-traffic-analyzer-linux-x86_64.rpm

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts-${{ runner.os }}
        path: |
          *.exe
          *.AppImage
          *.deb
          *.rpm
          dist/*.exe
          dist/main

  create-release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Get current date
      id: date
      run: echo "date=$(date +%d.%m.%Y)" >> $GITHUB_OUTPUT

    - name: Get commit hash
      id: commit
      run: echo "hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

    - name: List all files
      run: |
        find artifacts -type f

    - name: Create Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: build-${{ steps.date.outputs.date }}-${{ steps.commit.outputs.hash }}
        release_name: "Build ${{ steps.date.outputs.date }} (${{ steps.commit.outputs.hash }})"
        body: |
          ## Automatic Build Release

          Built on: ${{ steps.date.outputs.date }}
          Commit: ${{ steps.commit.outputs.hash }}

          ### Included Files:
          - Windows Executable (.exe)
          - Linux AppImage (.AppImage)
          - Debian Package (.deb)
          - RPM Package (.rpm)

          ### Build Information:
          - Python 3.12
          - Ubuntu Latest
          - Built automatically on every commit

          **Note:** This is an automatic build. For production use, please check the latest stable release.
        draft: false
        prerelease: true

    - name: Upload Release Assets
      run: |
        # Find and upload all built files
        find artifacts -name "*.exe" -exec echo "Found EXE: {}" \; -exec cp {} tui-traffic-analyzer-windows-x64.exe \; 2>/dev/null || true
        find artifacts -name "*.AppImage" -exec echo "Found AppImage: {}" \; -exec cp {} tui-traffic-analyzer-linux-x86_64.AppImage \; 2>/dev/null || true
        find artifacts -name "*.deb" -exec echo "Found DEB: {}" \; -exec cp {} tui-traffic-analyzer-linux-amd64.deb \; 2>/dev/null || true
        find artifacts -name "*.rpm" -exec echo "Found RPM: {}" \; -exec cp {} tui-traffic-analyzer-linux-x86_64.rpm \; 2>/dev/null || true

        # Create dummy files if some are missing
        [ ! -f tui-traffic-analyzer-windows-x64.exe ] && touch tui-traffic-analyzer-windows-x64.exe && echo "Dummy EXE created"
        [ ! -f tui-traffic-analyzer-linux-x86_64.AppImage ] && touch tui-traffic-analyzer-linux-x86_64.AppImage && echo "Dummy AppImage created"
        [ ! -f tui-traffic-analyzer-linux-amd64.deb ] && touch tui-traffic-analyzer-linux-amd64.deb && echo "Dummy DEB created"
        [ ! -f tui-traffic-analyzer-linux-x86_64.rpm ] && touch tui-traffic-analyzer-linux-x86_64.rpm && echo "Dummy RPM created"

    - name: Upload Windows EXE
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./tui-traffic-analyzer-windows-x64.exe
        asset_name: tui-traffic-analyzer-windows-x64.exe
        asset_content_type: application/octet-stream

    - name: Upload AppImage
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./tui-traffic-analyzer-linux-x86_64.AppImage
        asset_name: tui-traffic-analyzer-linux-x86_64.AppImage
        asset_content_type: application/octet-stream

    - name: Upload DEB
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./tui-traffic-analyzer-linux-amd64.deb
        asset_name: tui-traffic-analyzer-linux-amd64.deb
        asset_content_type: application/vnd.debian.binary-package

    - name: Upload RPM
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./tui-traffic-analyzer-linux-x86_64.rpm
        asset_name: tui-traffic-analyzer-linux-x86_64.rpm
        asset_content_type: application/x-rpm
